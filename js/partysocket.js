/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/partysocket@1.0.1/dist/index.mjs
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function t(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}var s=t,r=o;function n(e){if(s===setTimeout)return setTimeout(e,0);if((s===t||!s)&&setTimeout)return s=setTimeout,setTimeout(e,0);try{return s(e,0)}catch(t){try{return s.call(null,e,0)}catch(t){return s.call(this,e,0)}}}"function"==typeof e.setTimeout&&(s=setTimeout),"function"==typeof e.clearTimeout&&(r=clearTimeout);var i,h=[],a=!1,c=-1;function u(){a&&i&&(a=!1,i.length?h=i.concat(h):c=-1,h.length&&l())}function l(){if(!a){var e=n(u);a=!0;for(var t=h.length;t;){for(i=h,h=[];++c<t;)i&&i[c].run();c=-1,t=h.length}i=null,a=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{return r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function _(e,t){this.fun=e,this.array=t}_.prototype.run=function(){this.fun.apply(null,this.array)};function p(){}var d=p,m=p,f=p,g=p,y=p,w=p,v=p;var b=e.performance||{},T=b.now||b.mozNow||b.msNow||b.oNow||b.webkitNow||function(){return(new Date).getTime()};var x=new Date;var E={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var o=1;o<arguments.length;o++)t[o-1]=arguments[o];h.push(new _(e,t)),1!==h.length||a||n(l)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:d,addListener:m,once:f,off:g,removeListener:y,removeAllListeners:w,emit:v,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*T.call(b),o=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(o-=e[0],(s-=e[1])<0&&(o--,s+=1e9)),[o,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-x)/1e3}};globalThis.EventTarget&&globalThis.Event||console.error("\n  PartySocket requires a global 'EventTarget' class to be available!\n  You can polyfill this global by adding this to your code before any partysocket imports: \n  \n  ```\n  import 'partysocket/event-target-polyfill';\n  ```\n  Please file an issue at https://github.com/partykit/partykit if you're still having trouble.\n");var k=class extends Event{message;error;constructor(e,t){super("error",t),this.message=e.message,this.error=e}},L=class extends Event{code;reason;wasClean=!0;constructor(e=1e3,t="",o){super("close",o),this.code=e,this.reason=t}},C=(Event,k),S=L;var P=void 0!==E&&void 0!==E.versions?.node&&"undefined"==typeof document?function(e){if("data"in e){return new MessageEvent(e.type,e)}if("code"in e||"reason"in e){return new L(e.code||1999,e.reason||"unknown reason",e)}if("error"in e){return new k(e.error,e)}return new Event(e.type,e)}:function(e){return new e.constructor(e.type,e)},O={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},N=!1,D=class e extends EventTarget{_ws;_retryCount=-1;_uptimeTimeout;_connectTimeout;_shouldReconnect=!0;_connectLock=!1;_binaryType="blob";_closeCalled=!1;_messageQueue=[];_debugLogger=console.log.bind(console);_url;_protocols;_options;constructor(e,t,o={}){super(),this._url=e,this._protocols=t,this._options=o,this._options.startClosed&&(this._shouldReconnect=!1),this._options.debugLogger&&(this._debugLogger=this._options.debugLogger),this._connect()}static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}get CONNECTING(){return e.CONNECTING}get OPEN(){return e.OPEN}get CLOSING(){return e.CLOSING}get CLOSED(){return e.CLOSED}get binaryType(){return this._ws?this._ws.binaryType:this._binaryType}set binaryType(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)}get retryCount(){return Math.max(this._retryCount,0)}get bufferedAmount(){return this._messageQueue.reduce(((e,t)=>("string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e)),0)+(this._ws?this._ws.bufferedAmount:0)}get extensions(){return this._ws?this._ws.extensions:""}get protocol(){return this._ws?this._ws.protocol:""}get readyState(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING}get url(){return this._ws?this._ws.url:""}get shouldReconnect(){return this._shouldReconnect}onclose=null;onerror=null;onmessage=null;onopen=null;close(e=1e3,t){this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")}reconnect(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()}send(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{const{maxEnqueuedMessages:t=O.maxEnqueuedMessages}=this._options;this._messageQueue.length<t&&(this._debug("enqueue",e),this._messageQueue.push(e))}}_debug(...e){this._options.debug&&this._debugLogger("RWS>",...e)}_getNextDelay(){const{reconnectionDelayGrowFactor:e=O.reconnectionDelayGrowFactor,minReconnectionDelay:t=O.minReconnectionDelay,maxReconnectionDelay:o=O.maxReconnectionDelay}=this._options;let s=0;return this._retryCount>0&&(s=t*Math.pow(e,this._retryCount-1),s>o&&(s=o)),this._debug("next delay",s),s}_wait(){return new Promise((e=>{setTimeout(e,this._getNextDelay())}))}_getNextProtocols(e){if(!e)return Promise.resolve(null);if("string"==typeof e||Array.isArray(e))return Promise.resolve(e);if("function"==typeof e){const t=e();if(!t)return Promise.resolve(null);if("string"==typeof t||Array.isArray(t))return Promise.resolve(t);if(t.then)return t}throw Error("Invalid protocols")}_getNextUrl(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){const t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")}_connect(){if(this._connectLock||!this._shouldReconnect)return;this._connectLock=!0;const{maxRetries:e=O.maxRetries,connectionTimeout:t=O.connectionTimeout}=this._options;this._retryCount>=e?this._debug("max retries reached",this._retryCount,">=",e):(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),this._wait().then((()=>Promise.all([this._getNextUrl(this._url),this._getNextProtocols(this._protocols||null)]))).then((([e,o])=>{if(this._closeCalled)return void(this._connectLock=!1);this._options.WebSocket||"undefined"!=typeof WebSocket||N||(console.error("‼️ No WebSocket implementation available. You should define options.WebSocket. \n\nFor example, if you're using node.js, run `npm install ws`, and then in your code:\n\nimport PartySocket from 'partysocket';\nimport WS from 'ws';\n\nconst partysocket = new PartySocket({\n  host: \"127.0.0.1:1999\",\n  room: \"test-room\",\n  WebSocket: WS\n});\n\n"),N=!0);const s=this._options.WebSocket||WebSocket;this._debug("connect",{url:e,protocols:o}),this._ws=o?new s(e,o):new s(e),this._ws.binaryType=this._binaryType,this._connectLock=!1,this._addListeners(),this._connectTimeout=setTimeout((()=>this._handleTimeout()),t)})).catch((e=>{this._connectLock=!1,this._handleError(new C(Error(e.message),this))})))}_handleTimeout(){this._debug("timeout event"),this._handleError(new C(Error("TIMEOUT"),this))}_disconnect(e=1e3,t){if(this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new S(e,t,this))}catch(e){}}}_acceptOpen(){this._debug("accept open"),this._retryCount=0}_handleOpen=e=>{this._debug("open event");const{minUptime:t=O.minUptime}=this._options;clearTimeout(this._connectTimeout),this._uptimeTimeout=setTimeout((()=>this._acceptOpen()),t),function(e,t){if(!e)throw new Error(t)}(this._ws,"WebSocket is not defined"),this._ws.binaryType=this._binaryType,this._messageQueue.forEach((e=>this._ws?.send(e))),this._messageQueue=[],this.onopen&&this.onopen(e),this.dispatchEvent(P(e))};_handleMessage=e=>{this._debug("message event"),this.onmessage&&this.onmessage(e),this.dispatchEvent(P(e))};_handleError=e=>{this._debug("error event",e.message),this._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),this.onerror&&this.onerror(e),this._debug("exec error listeners"),this.dispatchEvent(P(e)),this._connect()};_handleClose=e=>{this._debug("close event"),this._clearTimeouts(),this._shouldReconnect&&this._connect(),this.onclose&&this.onclose(e),this.dispatchEvent(P(e))};_removeListeners(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))}_addListeners(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))}_clearTimeouts(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)}},W=e=>null!==e[1]&&void 0!==e[1];function R(e,t,o={}){const{host:s,path:r,protocol:n,room:i,party:h,query:a}=e;let c=s.replace(/^(http|https|ws|wss):\/\//,"");if(c.endsWith("/")&&(c=c.slice(0,-1)),r&&r.startsWith("/"))throw new Error("path must not start with a slash");const u=h??"main",l=r?`/${r}`:"",_=n||(c.startsWith("localhost:")||c.startsWith("127.0.0.1:")||c.startsWith("192.168.")||c.startsWith("10.")||c.startsWith("172.")&&c.split(".")[1]>="16"&&c.split(".")[1]<="31"||c.startsWith("[::ffff:7f00:1]:")?t:t+"s"),p=`${_}://${c}/${h?`parties/${h}`:"party"}/${i}${l}`,d=(e={})=>`${p}?${new URLSearchParams([...Object.entries(o),...Object.entries(e).filter(W)])}`,m="function"==typeof a?async()=>d(await a()):d(a);return{host:c,path:l,room:i,name:u,protocol:_,partyUrl:p,urlProvider:m}}var M=class extends D{constructor(e){const t=U(e);super(t.urlProvider,t.protocols,t.socketOptions),this.partySocketOptions=e,this.setWSProperties(t)}_pk;_pkurl;name;room;host;path;updateProperties(e){const t=U({...this.partySocketOptions,...e,host:e.host??this.host,room:e.room??this.room,path:e.path??this.path});this._url=t.urlProvider,this._protocols=t.protocols,this._options=t.socketOptions,this.setWSProperties(t)}setWSProperties(e){const{_pk:t,_pkurl:o,name:s,room:r,host:n,path:i}=e;this._pk=t,this._pkurl=o,this.name=s,this.room=r,this.host=n,this.path=i}reconnect(e,t){if(!this.room||!this.host)throw new Error("The room and host must be set before connecting, use `updateProperties` method to set them or pass them to the constructor.");super.reconnect(e,t)}get id(){return this._pk}get roomUrl(){return this._pkurl}static async fetch(e,t){const o=R(e,"http"),s="string"==typeof o.urlProvider?o.urlProvider:await o.urlProvider();return(e.fetch??fetch)(s,t)}};function U(e){const{id:t,host:o,path:s,party:r,room:n,protocol:i,query:h,protocols:a,...c}=e,u=t||function(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();let e=(new Date).getTime(),t="undefined"!=typeof performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(o){let s=16*Math.random();return e>0?(s=(e+s)%16|0,e=Math.floor(e/16)):(s=(t+s)%16|0,t=Math.floor(t/16)),("x"===o?s:3&s|8).toString(16)}))}(),l=R(e,"ws",{_pk:u});return{_pk:u,_pkurl:l.partyUrl,name:l.name,room:l.room,host:l.host,path:l.path,protocols:a,socketOptions:c,urlProvider:l.urlProvider}}export{M as PartySocket,D as WebSocket,M as default};
//# sourceMappingURL=/sm/ea633c0401a514f836c5ea1224d1fadd5c30e8f559c038f97499d8f7eb4bd80e.map